{% extends "employee/employee_base.html" %}
{% block content %}
<div class="space-y-8">

  <!-- Header -->
  <div class="flex justify-between items-center">
    <h2 class="text-xl font-semibold text-blue-700 flex items-center gap-2">
      üì§ Phi·∫øu xu·∫•t kho: <span class="text-gray-700 font-medium">C·ª≠a h√†ng ch√≠nh</span>
    </h2>
  </div>

  <!-- Form Phi·∫øu xu·∫•t -->
  <div class="bg-white rounded-xl shadow border border-gray-100 p-6">
    <form method="POST" class="space-y-6">
      {% csrf_token %}

      <!-- Th√¥ng tin phi·∫øu -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">M√£ phi·∫øu xu·∫•t</label>
          <input type="text" name="export_code" placeholder="T·ª± ƒë·ªông t·∫°o khi l∆∞u"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 text-gray-700" readonly>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ng√†y xu·∫•t</label>
          <input type="text" name="export_date"
                 value="{{ today|date:'d/m/Y' }}"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Nh√¢n vi√™n xu·∫•t</label>
          <input type="text" name="employee" value="{{ request.user.get_full_name }}"
                 class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 text-gray-700" readonly>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê∆°n h√†ng li√™n quan</label>
          <select name="order"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 text-gray-700 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
            <option value="">-- Kh√¥ng c√≥ / Xu·∫•t n·ªôi b·ªô --</option>
            {% for order in orders %}
              <option value="{{ order.id }}">ƒê∆°n h√†ng #{{ order.id }} - {{ order.customer.cust_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-gray-700 mb-2">L√Ω do xu·∫•t kho</label>
          <textarea name="reason" rows="3"
                    placeholder="V√≠ d·ª•: Xu·∫•t h√†ng cho chi nh√°nh A, ho·∫∑c xu·∫•t tr·∫£ NCC..."
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition resize-none"></textarea>
        </div>
      </div>

      <!-- Danh s√°ch s·∫£n ph·∫©m -->
      <div class="mt-8">
        <h3 class="text-lg font-semibold text-blue-700 mb-3">Danh s√°ch s·∫£n ph·∫©m xu·∫•t</h3>

        <table class="w-full text-sm text-left border border-gray-200 rounded-lg overflow-hidden">
          <thead class="bg-gray-50 text-gray-700 font-semibold">
            <tr>
              <th class="px-4 py-2 border-b">#</th>
              <th class="px-4 py-2 border-b">S·∫£n ph·∫©m</th>
              <th class="px-4 py-2 border-b text-right">S·ªë l∆∞·ª£ng</th>
              <th class="px-4 py-2 border-b text-right">ƒê∆°n gi√° (VNƒê)</th>
              <th class="px-4 py-2 border-b text-right">Th√†nh ti·ªÅn</th>
            </tr>
          </thead>
          <tbody id="product-rows">
            <tr class="product-row">
              <td class="px-4 py-2 border-b text-gray-600">1</td>
              <td class="px-4 py-2 border-b">
                <select name="product[]" class="w-full border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
                  <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                  {% for product in products %}
                    <option value="{{ product.id }}">{{ product.product_name }} (T·ªìn: {{ product.quantity }})</option>
                  {% endfor %}
                </select>
              </td>
              <td class="px-4 py-2 border-b">
                <input type="number" name="quantity[]" min="1" value="1"
                       class="qty-input w-full text-right border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
              </td>
              <td class="px-4 py-2 border-b">
                <input type="number" name="unit_price[]" min="0" step="100" value="0"
                       class="price-input w-full text-right border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition">
              </td>
              <td class="px-4 py-2 border-b text-right font-medium text-gray-700 total-cell">0</td>
            </tr>
          </tbody>
        </table>

        <div class="flex justify-end mt-3">
          <button type="button" id="add-row"
                  class="px-3 py-1.5 text-sm bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
            ‚ûï Th√™m s·∫£n ph·∫©m
          </button>
        </div>
      </div>

      <!-- T·ªïng gi√° tr·ªã -->
      <div class="flex justify-end mt-6 border-t border-gray-200 pt-4">
        <div class="text-right">
          <p class="text-gray-600 text-sm">T·ªïng gi√° tr·ªã:</p>
          <p class="text-lg font-semibold text-blue-700" id="total-amount">0 VNƒê</p>
        </div>
      </div>

      <!-- N√∫t x√°c nh·∫≠n -->
      <div class="flex justify-end pt-4 border-t border-gray-200">
        <button type="submit"
                class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 hover:shadow-md transition-all duration-200">
          üíæ X√°c nh·∫≠n xu·∫•t kho
        </button>
      </div>
    </form>
  </div>

  <!-- Danh s√°ch phi·∫øu xu·∫•t g·∫ßn ƒë√¢y -->
  <div class="bg-white rounded-xl shadow border border-gray-100 p-6">
    <h3 class="text-lg font-semibold text-blue-700 mb-4">üìú Danh s√°ch phi·∫øu xu·∫•t g·∫ßn ƒë√¢y</h3>

    {% if export_orders %}
    <table class="w-full text-sm text-left border border-gray-200 rounded-lg overflow-hidden">
      <thead class="bg-gray-50 text-gray-700 font-semibold">
        <tr>
          <th class="px-4 py-2 border-b">#</th>
          <th class="px-4 py-2 border-b">M√£ phi·∫øu</th>
          <th class="px-4 py-2 border-b">Ng√†y xu·∫•t</th>
          <th class="px-4 py-2 border-b">Nh√¢n vi√™n</th>
          <th class="px-4 py-2 border-b text-right">S·ªë SP</th>
          <th class="px-4 py-2 border-b text-right">T·ªïng ti·ªÅn (VNƒê)</th>
          <th class="px-4 py-2 border-b">Ghi ch√∫</th>
          <th class="px-4 py-2 border-b text-center">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        {% for eo in export_orders %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-4 py-2 border-b text-gray-600">{{ forloop.counter }}</td>
          <td class="px-4 py-2 border-b font-medium text-blue-700">{{ eo.export_code }}</td>
          <td class="px-4 py-2 border-b">{{ eo.export_date|date:"d/m/Y" }}</td>
          <td class="px-4 py-2 border-b">{{ eo.employee.get_full_name }}</td>
          <td class="px-4 py-2 border-b text-right">{{ eo.export_items.count }}</td>
          <td class="px-4 py-2 border-b text-right">{{ eo.total_amount|floatformat:0 }} ‚Ç´</td>
          <td class="px-4 py-2 border-b text-gray-600">{{ eo.reason|default:"‚Äî" }}</td>
          <td class="px-4 py-2 border-b text-center">
            <a href="{% url 'employee:export_order_detail' eo.id %}" class="text-blue-600 hover:underline">Xem</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-gray-500 italic">Ch∆∞a c√≥ phi·∫øu xu·∫•t kho n√†o ƒë∆∞·ª£c t·∫°o.</p>
    {% endif %}
  </div>
</div>

<!-- JS x·ª≠ l√Ω th√™m d√≤ng v√† t√≠nh t·ªïng -->
<script>
function updateTotals() {
  let total = 0;
  document.querySelectorAll("#product-rows tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".qty-input")?.value || 0);
    const price = parseFloat(row.querySelector(".price-input")?.value || 0);
    const amount = qty * price;
    row.querySelector(".total-cell").textContent = amount.toLocaleString("vi-VN");
    total += amount;
  });
  document.getElementById("total-amount").textContent = total.toLocaleString("vi-VN") + " VNƒê";
}

document.getElementById("add-row").addEventListener("click", function() {
  const tableBody = document.getElementById("product-rows");
  const rowCount = tableBody.rows.length + 1;
  const newRow = tableBody.rows[0].cloneNode(true);
  newRow.querySelectorAll("input, select").forEach(el => el.value = "");
  newRow.querySelector("td").innerText = rowCount;
  tableBody.appendChild(newRow);
});

document.addEventListener("input", e => {
  if (e.target.classList.contains("qty-input") || e.target.classList.contains("price-input")) {
    updateTotals();
  }
});
</script>
{% endblock %}
