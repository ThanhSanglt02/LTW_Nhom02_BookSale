{% extends "employee/employee_base.html" %} {% load humanize %} {% block content %}

<style>
    .order-section {
        background: #f4f7ff;
        padding: 20px;
        border-radius: 14px;
        border: 1px solid #d8e2f9;
        margin-top: 25px;
    }

    .order-title {
        font-size: 18px;
        font-weight: 700;
        color: #283a80;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 15px;
    }

    .order-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #d6d9e5;
    }

    .order-table th {
        background: #e5edff;
        padding: 10px;
        text-align: center;
        font-weight: 700;
        color: #243577;
        font-size: 14px;
        border-bottom: 1px solid #d6d9e5;
    }

    .order-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #edf0f7;
        font-size: 14px;
    }

    .order-table tr:last-child td {
        border-bottom: none;
    }

    .order-total {
        text-align: right;
        margin-top: 18px;
        font-size: 18px;
        font-weight: 800;
        color: #243577;
    }
</style>

<div class="px-6 py-5">
    <h2 class="text-2xl font-semibold text-blue-600 mb-6 flex items-center gap-2">
        üì§ T·∫°o Phi·∫øu Xu·∫•t Kho
    </h2>

    <div class="bg-blue-50 p-6 rounded-xl shadow border border-blue-100">
        <!-- H√†ng 1 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="font-medium text-gray-700">Ng√†y xu·∫•t kho:</label>
                <input
                    type="text"
                    value="{{ today }}"
                    class="w-full mt-1 p-2 border rounded bg-gray-100"
                    disabled
                />
            </div>

            <div>
                <label class="font-medium text-gray-700">Nh√¢n vi√™n th·ª±c hi·ªán:</label>
                <input
                    type="text"
                    value="{{ employee.emp_name }}"
                    class="w-full mt-1 p-2 border rounded bg-gray-100"
                    disabled
                />
            </div>
        </div>

        <!-- Ch·ªçn ƒë∆°n h√†ng -->
        <div class="mt-2">
            <label class="font-medium text-gray-700">ƒê∆°n h√†ng:</label>
            <select id="orderSelect" class="w-full mt-1 p-2 border rounded bg-white">
                <option value="">‚Äî Ch·ªçn ƒë∆°n h√†ng ‚Äî</option>
                {% for o in orders %}
                <option value="{{ o.id }}">ƒêH#{{ o.id }} ‚Äî {{ o.customer.cust_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- L√Ω do -->
        <div class="mt-4">
            <label class="font-medium text-gray-700">L√Ω do xu·∫•t kho:</label>
            <textarea
                id="reasonInput"
                class="w-full mt-1 p-2 border rounded"
                placeholder="Xu·∫•t theo ƒë∆°n h√†ng..."
                rows="3"
            ></textarea>
        </div>

        <!-- Th√¥ng tin kh√°ch -->
        <div id="customerInfo" class="mt-6 hidden fade">
            <h3 class="font-semibold text-gray-700 mb-2">üßæ Th√¥ng tin kh√°ch h√†ng:</h3>
            <p><b>T√™n:</b> <span id="cusName"></span></p>
            <p><b>ƒêi·ªán tho·∫°i:</b> <span id="cusPhone"></span></p>
            <p><b>ƒê·ªãa ch·ªâ:</b> <span id="cusAddr"></span></p>
        </div>

        <!-- S·∫£n ph·∫©m (UI m·ªõi ƒë·∫πp) -->
        <div id="productTableWrapper" class="order-section hidden">
            <div class="order-title">üì¶ S·∫£n ph·∫©m trong ƒë∆°n h√†ng:</div>

            <table class="order-table">
                <thead>
                    <tr>
                        <th style="width: 40%">S·∫£n ph·∫©m</th>
                        <th style="width: 12%">SL</th>
                        <th style="width: 20%">ƒê∆°n gi√°</th>
                        <th style="width: 20%">Th√†nh ti·ªÅn</th>
                    </tr>
                </thead>

                <tbody id="exportItems"></tbody>
            </table>

            <div class="order-total">T·ªïng ti·ªÅn: <span id="exportTotal">0 ƒë</span></div>
        </div>

        <!-- Submit -->
        <form method="POST" class="mt-6">
            {% csrf_token %}
            <input type="hidden" name="order_id" id="hiddenOrderId" />
            <input type="hidden" name="reason" id="hiddenReason" />
            <input type="hidden" name="qty_submit" value="1" />

            <button
                onclick="return confirmSubmit();"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
            >
                üíæ L∆∞u phi·∫øu xu·∫•t
            </button>
        </form>
    </div>
</div>

<script>
    function confirmSubmit() {
        document.getElementById('hiddenReason').value =
            document.getElementById('reasonInput').value;
    }

    document.getElementById('orderSelect').addEventListener('change', function () {
        let id = this.value;
        if (!id) return;

        fetch(`/employee/api/order/${id}/`)
            .then((res) => res.json())
            .then((data) => {
                // HI·ªÜN TH√îNG TIN KH√ÅCH
                document.getElementById('customerInfo').classList.remove('hidden');
                document.getElementById('cusName').innerText = data.customer.name;
                document.getElementById('cusPhone').innerText = data.customer.phone;
                document.getElementById('cusAddr').innerText = data.customer.address;

                // RENDER S·∫¢N PH·∫®M (UI ƒë·∫πp)
                const tbody = document.getElementById('exportItems');
                tbody.innerHTML = '';

                data.items.forEach((p) => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.product}</td>
                            <td style="text-align:center;">${p.quantity}</td>
                            <td style="text-align:right;">${p.price.toLocaleString('vi-VN')}</td>
                            <td style="text-align:right;">${p.total.toLocaleString('vi-VN')}</td>
                        </tr>
                    `;
                });

                // HI·ªÜN B·∫¢NG S·∫¢N PH·∫®M
                document.getElementById('productTableWrapper').classList.remove('hidden');

                // T·ªîNG TI·ªÄN
                document.getElementById('exportTotal').innerText =
                    data.total_amount + ' ƒë';

                // SET ORDER ID
                document.getElementById('hiddenOrderId').value = id;
            });
    });
</script>

{% endblock %}
