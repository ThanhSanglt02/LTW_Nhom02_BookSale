{% extends "user_temp/base.html" %}
{% load static %}

{% block title %}{{ product.product_name }} - Chi tiết sản phẩm{% endblock %}

{% block extra_css %}
<style>
/* ======= KHUNG CHUNG ======= */
.product-page { margin-top: 120px; padding-bottom: 50px; }
.product-main { display: flex; flex-wrap: wrap; gap: 40px; }
.product-img-main { flex: 1; min-width: 300px; text-align: center; }
.product-img-main img { width: 100%; max-width: 400px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.3s; }
.product-img-main img:hover { transform: scale(1.02); }
.thumb-list { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
.thumb-list img { width: 60px; height: 60px; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: 0.3s; }
.thumb-list img:hover { border-color: #007bff; transform: scale(1.1); }

/* ======= THÔNG TIN ======= */
.product-info { flex: 2; min-width: 250px; display: flex; flex-direction: column; justify-content: flex-start; }
.product-title { font-size: 2rem; font-weight: 700; color: #232f3e; margin-bottom: 10px; }
.product-brand { color: #555; margin-bottom: 10px; }
.product-price { color: #e47911; font-size: 1.6rem; font-weight: bold; margin-bottom: 20px; }
.btn-buy { background-color: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-weight: 600; }
.btn-buy:hover { background-color: #0056b3; }

/* ======= TAB MÔ TẢ ======= */
.tab-section { margin-top: 50px; }
.tab-title { font-weight: 700; border-bottom: 2px solid #007bff; display: inline-block; margin-bottom: 15px; }
.product-desc { line-height: 1.6; color: #333; font-size: 1rem; }

/* ======= ĐÁNH GIÁ ======= */
.review-section { margin-top: 50px; }
.review-item { border-bottom: 1px solid #eee; padding: 15px 0; }
.review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
.review-user { font-weight: 600; }
.review-stars { color: #ffc107; }
.review-date { color: #999; font-size: 0.85rem; }

/* ======= SẢN PHẨM TƯƠNG TỰ ======= */
.related-section { margin-top: 60px; }
.related-title { font-weight: 700; font-size: 1.3rem; text-align: center; margin-bottom: 25px; }
.related-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
.related-item { text-align: center; background: #fafafa; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: 0.3s; }
.related-item:hover { transform: translateY(-5px); }
.related-item img { width: 100%; height: 220px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
.related-item h6 { margin: 0 0 5px; font-size: 0.95rem; color: #333; }
.related-price { color: #e47911; font-weight: bold; margin-bottom: 5px; }
.related-item button { background-color: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
.related-item button:hover { background-color: #0056b3; }
</style>
{% endblock %}

{% block content %}
<div class="container product-page">
  <div class="product-main">
    <!-- ẢNH SẢN PHẨM -->
    <div class="product-img-main">
      <img id="mainImg"
           src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'images/default-product.jpg' %}{% endif %}"
           alt="{{ product.product_name }}">
      <div class="thumb-list">
        {% if product.image %}
          <img src="{{ product.image.url }}" onclick="document.getElementById('mainImg').src=this.src">
        {% else %}
          <img src="{% static 'images/default-product.jpg' %}" onclick="document.getElementById('mainImg').src=this.src">
        {% endif %}
        {% for img in product.extra_images.all %}
          <img src="{{ img.image.url }}" onclick="document.getElementById('mainImg').src=this.src">
        {% endfor %}
      </div>
    </div>

    <!-- THÔNG TIN SẢN PHẨM -->
    <div class="product-info">
      <h2 class="product-title">{{ product.product_name }}</h2>
      <p class="product-brand">Thương hiệu: {{ product.publisher.publisher_name|default:"Đang cập nhật" }}</p>
      <p class="product-price">
        {% if product.sell_price %}
          {{ product.sell_price|floatformat:0 }} VND
        {% else %}
          Liên hệ
        {% endif %}
      </p>

      <!-- FORM MUA NGAY -->
      <form method="POST" action="{% url 'add_to_cart' product.id %}">
        {% csrf_token %}
        <button type="submit" class="btn-buy">Mua ngay</button>
      </form>
    </div>
  </div>

  <!-- MÔ TẢ SẢN PHẨM -->
  <div class="tab-section">
    <h4 class="tab-title">Tóm tắt và giới thiệu</h4>
    <p class="product-desc">{{ product.description|linebreaks }}</p>
  </div>

  <!-- ĐÁNH GIÁ SẢN PHẨM -->
  <div class="review-section">
    <h4 class="tab-title">Đánh giá sản phẩm</h4>
    {% for review in product.review_set.all %}
      <div class="review-item">
        <div class="review-header">
          <div>
            <span class="review-user">{{ review.creator.username }}</span>
            <span class="review-date">{{ review.date_created|date:"Y-m-d H:i" }}</span>
          </div>
          <div class="review-stars">
            {% for i in "12345"|make_list %}
              {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %}
            {% endfor %}
          </div>
        </div>
        <p>{{ review.content }}</p>
      </div>
    {% empty %}
      <p>Chưa có đánh giá nào cho sản phẩm này.</p>
    {% endfor %}
  </div>

  <!-- SẢN PHẨM TƯƠNG TỰ -->
  <div class="related-section">
    <h4 class="related-title">SẢN PHẨM TƯƠNG TỰ</h4>
    <div class="related-list">
      {% for item in related_products %}
        <div class="related-item">
          <a href="{% url 'product_detail_user' item.id %}">
            <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default-product.jpg' %}{% endif %}" alt="{{ item.product_name }}">
            <h6>{{ item.product_name|truncatechars:50 }}</h6>
          </a>
          <p class="related-price">
            {% if item.sell_price %}
              {{ item.sell_price|floatformat:0 }} VND
            {% else %}
              Liên hệ
            {% endif %}
          </p>
          <form method="POST" action="{% url 'add_to_cart' item.id %}">
            {% csrf_token %}
            <button type="submit" class="btn-buy">Mua ngay</button>
          </form>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
// Click thumbnail thay ảnh chính
const thumbs = document.querySelectorAll('.thumb-list img');
const mainImg = document.getElementById('mainImg');
thumbs.forEach(t => t.addEventListener('click', () => mainImg.src = t.src));
</script>
{% endblock %}