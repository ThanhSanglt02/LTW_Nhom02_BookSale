{% extends 'user_temp/base.html' %} {% load static %} {% block content %}

<style>
    /* Breadcrumb bar */
    .breadcrumb-bar {
        background-color: #f5f5f5;
        border-top: 1px solid #007bff;
        border-bottom: 1px solid #007bff;
        padding: 12px 0;
        margin-bottom: 20px;
    }

    .breadcrumb-content {
        width: 85%;
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .breadcrumb-home {
        color: #333;
        font-size: 18px;
        text-decoration: none;
        display: flex;
        align-items: center;
    }

    .breadcrumb-home:hover {
        color: #007bff;
    }

    .breadcrumb-separator {
        width: 1px;
        height: 20px;
        background-color: #ccc;
    }

    .breadcrumb-title {
        color: #6c5ce7;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .cart-container {
        width: 85%;
        margin: 40px auto;
        background: #fff;
        padding: 20px 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .cart-title {
        font-size: 26px;
        font-weight: 700;
        color: #1c2730;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    table.cart-table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
        margin-top: 10px;
    }

    table.cart-table thead {
        background-color: #1c2730;
        color: #fff;
        font-weight: bold;
    }

    table.cart-table th,
    table.cart-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #ddd;
    }

    table.cart-table tbody tr {
        background-color: #f9f9f9;
    }

    table.cart-table tbody tr:hover {
        background-color: #f0f0f0;
    }

    .product-info {
        display: flex;
        align-items: center;
        gap: 10px;
        text-align: left;
    }

    .product-info img {
        width: 65px;
        height: 80px;
        object-fit: cover;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    .product-details {
        display: flex;
        flex-direction: column;
    }

    .product-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .product-description {
        font-size: 12px;
        color: #666;
    }

    .qty-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #aaa;
        background: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .qty-btn:hover {
        background: #eaeaea;
    }

    .qty-input {
        width: 35px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .delete-btn {
        color: #ff4d4d;
        font-size: 18px;
        border: none;
        background: none;
        cursor: pointer;
    }

    .cart-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 25px;
        flex-wrap: wrap;
        gap: 10px;
    }

    #xoa-da-chon {
        background-color: #ddd;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
    }

    #xoa-da-chon:hover {
        background-color: #ccc;
    }

    .total-text {
        background-color: #f5f5f5;
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: bold;
    }

    .total-price {
        color: #007bff;
    }

    .btn-buy {
        background-color: #ff3333;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }

    .btn-buy:hover {
        background-color: #e52d2d;
    }

    /* Responsive cho mobile */
    @media (max-width: 768px) {
        .breadcrumb-bar {
            padding: 10px 0;
        }

        .breadcrumb-content {
            width: 95%;
            padding: 0 15px;
        }

        .breadcrumb-title {
            font-size: 14px;
        }

        .cart-container {
            width: 95%;
            margin: 20px auto;
            padding: 15px;
        }

        .cart-title {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* Ẩn table header trên mobile */
        table.cart-table thead {
            display: none;
        }

        /* Chuyển table thành card layout trên mobile */
        table.cart-table,
        table.cart-table tbody,
        table.cart-table tr,
        table.cart-table td {
            display: block;
            width: 100%;
        }

        table.cart-table tr {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table.cart-table td {
            border: none;
            padding: 8px 0;
            text-align: left;
            position: relative;
            padding-left: 0;
        }

        /* Labels cho các cột trên mobile */
        table.cart-table td:nth-child(2):before {
            content: 'Đơn giá: ';
            font-weight: bold;
            display: inline-block;
            width: 80px;
            color: #666;
        }

        table.cart-table td:nth-child(3):before {
            content: 'Số lượng: ';
            font-weight: bold;
            display: inline-block;
            width: 80px;
            color: #666;
        }

        table.cart-table td:nth-child(4):before {
            content: 'Tổng: ';
            font-weight: bold;
            display: inline-block;
            width: 80px;
            color: #666;
        }

        /* Sản phẩm */
        table.cart-table td:first-child {
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        table.cart-table td:first-child:before {
            display: none;
        }

        table.cart-table td:nth-child(3) {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Xóa */
        table.cart-table td:last-child {
            text-align: right;
            padding-top: 10px;
        }

        table.cart-table td:last-child:before {
            display: none;
        }

        .product-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .product-info img {
            width: 80px;
            height: 100px;
        }

        .product-details {
            width: 100%;
        }

        .cart-footer {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .cart-footer > div {
            width: 100%;
        }

        .cart-footer > div:last-child {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .total-text {
            text-align: center;
            padding: 12px;
        }

        .btn-buy {
            width: 100%;
            padding: 12px;
        }

        #xoa-da-chon {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
        }
    }

    @media (max-width: 576px) {
        .cart-container {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 0;
        }

        .cart-title {
            font-size: 18px;
        }

        .product-info img {
            width: 60px;
            height: 75px;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            font-size: 14px;
        }

        .qty-input {
            width: 30px;
            font-size: 14px;
        }

        .total-text {
            font-size: 14px;
            padding: 10px;
        }

        .btn-buy {
            font-size: 14px;
            padding: 10px;
        }
    }
</style>

<!-- Breadcrumb bar -->
<div class="breadcrumb-bar">
    <div class="breadcrumb-content">
        <a href="/" class="breadcrumb-home">
            <i class="fas fa-home"></i>
        </a>
        <div class="breadcrumb-separator"></div>
        <h2 class="breadcrumb-title">Giỏ hàng</h2>
    </div>
</div>

<div class="cart-container">
    <h2 class="cart-title">Giỏ hàng</h2>
    {% csrf_token %}

    <table class="cart-table">
        <thead>
            <tr>
                <th style="width: 40%">Sản phẩm</th>
                <th>Đơn giá</th>
                <th>Số lượng</th>
                <th>Tổng cộng</th>
                <th>Xóa</th>
            </tr>
        </thead>
        <tbody>
            {% if giohang %} {% for sp in giohang %}
            <tr id="row-{{ sp.id }}">
                <td data-label="">
                    <div class="product-info">
                        <input
                            type="checkbox"
                            class="item-checkbox"
                            value="{{ sp.id }}"
                            data-item-id="{{ sp.id }}"
                        />
                        <img src="{{ sp.image.url }}" alt="{{ sp.ten }}" />
                        <div class="product-details">
                            <div class="product-name">{{ sp.ten }}</div>
                            <div class="product-description">Mô tả</div>
                        </div>
                    </div>
                </td>
                <td
                    data-label="Đơn giá"
                    id="dongia-{{ sp.id }}"
                    style="color: #007bff"
                    data-value="{{ sp.dongia }}"
                >
                    {{ sp.dongia }}₫
                </td>
                <td data-label="Số lượng">
                    <button
                        class="qty-btn giam"
                        data-id="{{ sp.id }}"
                        data-max="{{ sp.max_quantity }}"
                    >
                        −
                    </button>
                    <input
                        type="text"
                        id="soluong-{{ sp.id }}"
                        name="quantity_{{ sp.id }}"
                        class="qty-input"
                        value="{{ sp.soluong }}"
                        data-max="{{ sp.max_quantity }}"
                        data-item-id="{{ sp.id }}"
                        readonly
                    />
                    <button
                        class="qty-btn tang"
                        data-id="{{ sp.id }}"
                        data-max="{{ sp.max_quantity }}"
                    >
                        +
                    </button>
                    <small
                        class="text-muted"
                        style="display: block; font-size: 11px; margin-top: 4px"
                        >Còn: {{ sp.max_quantity }}</small
                    >
                </td>
                <td
                    data-label="Tổng"
                    id="tong-{{ sp.id }}"
                    style="color: #007bff"
                    data-value="{{ sp.tong }}"
                >
                    {{ sp.tong }}₫
                </td>
                <td data-label="">
                    <button class="delete-btn xoa-item" data-item-id="{{ sp.id }}">✖</button>
                </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
                <td colspan="5" style="padding: 20px; color: #666">
                    Giỏ hàng của bạn hiện đang trống.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <div class="cart-footer">
        <div>
            <input type="checkbox" id="chon-tat-ca" /> <label for="chon-tat-ca">Chọn tất cả</label>
            <button id="xoa-da-chon">Xóa</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px">
            <div class="total-text">
                Tổng cộng ({{ giohang|length }} sản phẩm):
                <span id="tong-cong" class="total-price" data-value="{{ tong_cong }}"
                    >{{ tong_cong }}₫</span
                >
            </div>
            <form
                method="POST"
                action="{% url 'proceed_to_order' %}"
                id="proceed-to-order-form"
                style="margin: 0"
            >
                {% csrf_token %} {% for sp in giohang %}
                <input
                    type="hidden"
                    name="quantity_{{ sp.id }}"
                    id="hidden_quantity_{{ sp.id }}"
                    value="{{ sp.soluong }}"
                />
                {% endfor %}
                <button type="submit" class="btn-buy">Mua hàng</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formatCurrency = (num) => {
            if (typeof num === 'string') {
                num = parseFloat(num.replace(/[^\d.-]/g, '')) || 0;
            }
            return num.toLocaleString('vi-VN') + '₫';
        };

        // Format tất cả giá trị tiền khi load trang
        // document.querySelectorAll('[data-value]').forEach((element) => {
        //     const value = parseFloat(element.getAttribute('data-value')) || 0;
        //     if (
        //         element.id &&
        //         (element.id.startsWith('dongia-') || element.id.startsWith('tong-') || element.id === 'tong-cong')
        //     ) {
        //         element.textContent = formatCurrency(value);
        //     }
        // });

        // Hàm cập nhật hidden input
        function updateHiddenInput(itemId, quantity) {
            const hiddenInput = document.getElementById(`hidden_quantity_${itemId}`);
            if (hiddenInput) {
                hiddenInput.value = quantity;
            }
        }

        document.querySelectorAll('.tang').forEach((btn) => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                const maxQty = parseInt(this.dataset.max) || 999999;
                const soluong = document.getElementById(`soluong-${id}`);
                const dongia = parseInt(
                    document.getElementById(`dongia-${id}`).textContent.replace(/\D/g, ''),
                );
                let sl = parseInt(soluong.value);

                if (sl < maxQty) {
                    sl++;
                    soluong.value = sl;
                    document.getElementById(`tong-${id}`).textContent = formatCurrency(dongia * sl);
                    updateHiddenInput(id, sl);
                    capNhatTong();
                } else {
                    alert(`Sản phẩm chỉ còn ${maxQty} sản phẩm!`);
                }
            });
        });

        document.querySelectorAll('.giam').forEach((btn) => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                const soluong = document.getElementById(`soluong-${id}`);
                const dongia = parseInt(
                    document.getElementById(`dongia-${id}`).textContent.replace(/\D/g, ''),
                );
                let sl = parseInt(soluong.value);
                if (sl > 1) {
                    sl--;
                    soluong.value = sl;
                    document.getElementById(`tong-${id}`).textContent = formatCurrency(dongia * sl);
                    updateHiddenInput(id, sl);
                    capNhatTong();
                }
            });
        });

        // Xóa một item (dấu X)
        document.querySelectorAll('.xoa-item').forEach((btn) => {
            btn.addEventListener('click', function () {
                const itemId = this.dataset.itemId;
                if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                    xoaItem(itemId);
                }
            });
        });

        // Xóa các item đã chọn
        document.getElementById('xoa-da-chon').addEventListener('click', function () {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const chonTatCa = document.getElementById('chon-tat-ca').checked;

            if (chonTatCa) {
                // Xóa tất cả
                if (confirm('Bạn có chắc muốn xóa tất cả sản phẩm trong giỏ hàng?')) {
                    xoaTatCa();
                }
            } else if (checkboxes.length > 0) {
                // Xóa các item được chọn
                if (confirm(`Bạn có chắc muốn xóa ${checkboxes.length} sản phẩm đã chọn?`)) {
                    const selectedIds = Array.from(checkboxes).map((cb) => cb.value);
                    xoaNhieuItem(selectedIds);
                }
            } else {
                alert('Vui lòng chọn sản phẩm cần xóa');
            }
        });

        // Checkbox "Chọn tất cả"
        document.getElementById('chon-tat-ca').addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach((cb) => {
                cb.checked = this.checked;
            });
        });

        // Hàm lấy CSRF token
        function getCsrfToken() {
            const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenInput) {
                return tokenInput.value;
            }
            // Fallback: lấy từ cookie
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + '=') {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Hàm xóa một item
        function xoaItem(itemId) {
            const formData = new FormData();
            formData.append('item_id', itemId);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch('/cart/delete/', {
                method: 'POST',
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        document.getElementById(`row-${itemId}`).remove();
                        capNhatTong();
                        // Reload trang để cập nhật số lượng sản phẩm
                        setTimeout(() => location.reload(), 500);
                    } else {
                        alert(data.message || 'Có lỗi xảy ra');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa sản phẩm');
                });
        }

        // Hàm xóa nhiều item
        function xoaNhieuItem(itemIds) {
            const formData = new FormData();
            itemIds.forEach((id) => {
                formData.append('selected_items[]', id);
            });
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch('/cart/delete/', {
                method: 'POST',
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        itemIds.forEach((id) => {
                            const row = document.getElementById(`row-${id}`);
                            if (row) row.remove();
                        });
                        capNhatTong();
                        // Reload trang để cập nhật số lượng sản phẩm
                        setTimeout(() => location.reload(), 500);
                    } else {
                        alert(data.message || 'Có lỗi xảy ra');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa sản phẩm');
                });
        }

        // Hàm xóa tất cả
        function xoaTatCa() {
            const formData = new FormData();
            formData.append('delete_all', 'true');
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            fetch('/cart/delete/', {
                method: 'POST',
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        // Xóa tất cả rows
                        document.querySelectorAll('tbody tr').forEach((row) => {
                            if (row.id && row.id.startsWith('row-')) {
                                row.remove();
                            }
                        });
                        capNhatTong();
                        // Reload trang
                        setTimeout(() => location.reload(), 500);
                    } else {
                        alert(data.message || 'Có lỗi xảy ra');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa sản phẩm');
                });
        }

        function capNhatTong() {
            let tong = 0;
            document.querySelectorAll('tbody tr').forEach((row) => {
                const tongSp = row.querySelector('td:nth-child(4)');
                if (tongSp && !isNaN(parseInt(tongSp.textContent.replace(/\D/g, '')))) {
                    tong += parseInt(tongSp.textContent.replace(/\D/g, ''));
                }
            });
            document.getElementById('tong-cong').textContent = formatCurrency(tong);
        }

        // Nút Mua hàng - cập nhật hidden inputs trước khi submit
        document.getElementById('proceed-to-order-form').addEventListener('submit', function (e) {
            // Cập nhật tất cả hidden inputs với số lượng hiện tại
            document.querySelectorAll('.qty-input').forEach((input) => {
                const itemId = input.dataset.itemId;
                const quantity = input.value;
                updateHiddenInput(itemId, quantity);
            });
            // Form sẽ submit tự động
        });
    });
</script>

{% endblock %}
